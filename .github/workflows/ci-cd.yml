name: WSO2 MI CI/CD

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong!Passw0rd
        ports:
          - 1433:1433
        options: >-
          --health-cmd "timeout 5 bash -c 'echo > /dev/tcp/localhost/1433'" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 10

    steps:
    # 1. Checkout code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Setup Java & Maven
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    # 3. Build CAR file
    - name: Build CAR
      run: mvn clean package

    # 4. Run WSO2 MI in Docker with your CAR deployed
    - name: Run WSO2 MI
      run: |
        docker run -d --name wso2mi \
        -p 8290:8290 -p 8253:8253 \
        -v ${{ github.workspace }}/target:/home/wso2carbon/wso2mi/repository/deployment/server/carbonapps \
        wso2/wso2mi:4.4.0


    # 5. Wait for MI to start
    - name: Wait for WSO2 MI
      run: sleep 60

    - name: Show MI logs
      if: failure()
      run: docker logs wso2mi

    # 6. Test API endpoint
    - name: Test Data Service
      run: |
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8290/services/mssql/data)
        if [ "$RESPONSE" -ne 200 ]; then
          echo "❌ API test failed with HTTP code $RESPONSE"
          exit 1
        fi
        echo "✅ API test passed"

    # 7. (Optional) Deploy to Production MI
    - name: Deploy to Prod MI
      if: github.ref == 'refs/heads/main'
      run: |
        curl -u ${{ secrets.WSO2_USER }}:${{ secrets.WSO2_PASS }} \
          -T target/*.car \
          http://prod-mi.example.com:8290/carbonapps
